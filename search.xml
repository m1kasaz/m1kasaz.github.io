<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä¸šåŠ¡åŠŸèƒ½--ä¼˜æƒ åˆ¸ç§’æ€(ä¼˜åŒ–)</title>
      <link href="/2025/07/25/2025.7.25/"/>
      <url>/2025/07/25/2025.7.25/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>åœ¨ä¼˜åŒ–ä¹‹å‰æˆ‘ä»¬å®Œæˆäº†åŸºäºredisåˆ†å¸ƒå¼é”çš„ä¼˜æƒ åˆ¸ç§’æ€åŠŸèƒ½ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½å¹¶ä¸å®Œå–„ï¼Œè™½ç„¶èƒ½ç”¨ä½†åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹å¤„ç†é€Ÿåº¦æ˜¯å¾ˆæ…¢çš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<br>æˆ‘ä»¬å›é¡¾ä¸€éä¸šåŠ¡æµç¨‹ï¼šç”¨æˆ·ä¸‹å•-åˆ¤æ–­åº“å­˜-å°è¯•åŠ é”-æ·»åŠ è®¢å•-è¿”å›è®¢å•ï¼Œè¿™æ ·æˆ‘ä»¬ä¸šåŠ¡æµç¨‹æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™æ ·æ¯æ¬¡ç”¨æˆ·ä¸‹å•éƒ½ä¼šæ‰§è¡Œè¿™ä¸€æ•´å¥—æµç¨‹ï¼Œé€Ÿåº¦æ˜¯å¾ˆæ…¢çš„ã€‚å¦‚ä½•ä¼˜åŒ–å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ä½•ä¸å°†æ·»åŠ è®¢å•çš„è¿‡ç¨‹äº¤ç»™å¦ä¸€äº›çº¿ç¨‹å»å®Œæˆï¼Œå°†åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒæ·»åŠ è®¢å•çš„åŒæ—¶ï¼Œä¸ºå¦å¤–ä¸€äº›ç”¨æˆ·æ·»åŠ è®¢å•ï¼Œåˆ¤æ–­å’Œæ·»åŠ è¿‡ç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œè¿™æ ·æ•ˆç‡æ˜æ˜¾æ›´é«˜ã€‚</p><h1>åˆ©ç”¨luaè„šæœ¬ä¿è¯ä¸šåŠ¡çš„åŸå­æ€§</h1><blockquote><p>ä¸ºäº†ä¿è¯åˆ¤æ–­ä¸šåŠ¡çš„åŸå­æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨luaè„šæœ¬ç¼–å†™åˆ¤æ–­ä¸šåŠ¡çš„ä»£ç ã€‚</p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>];</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>];</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>];</span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> storeKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, storeKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, storeKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br></pre></td></tr></table></figure><h1>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ä¼˜åŒ–</h1><blockquote><p>é˜»å¡é˜Ÿåˆ—ï¼šä¸çŸ¥é“å¤§ä¼™æœ‰æ²¡æœ‰äº†è§£è¿‡ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œç”Ÿäº§è€…ä¸æ–­å°†äº§å“æ”¾å…¥ä¸´ç•ŒåŒºä¸­ï¼Œè¿™äº›äº§å“ç§°ä¸ºä¸´ç•Œèµ„æºï¼Œç„¶åæ¶ˆè´¹è€…ä¸æ–­ä»ä¸´ç•ŒåŒºä¸­æ‹¿å–èµ„æºæ¶ˆè´¹ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åœ¨é‡Œé¢å°±æ‰®æ¼”ä¸´ç•ŒåŒºçš„è§’è‰²ã€‚</p><p>çº¿ç¨‹æ± ï¼šçº¿ç¨‹æ± æ‹…ä»»ä¸€ä¸ªç®¡ç†å’Œé‡ç”¨çº¿ç¨‹çš„è§’è‰²ï¼Œå½“ä»»åŠ¡åˆ°æ¥æ—¶ï¼Œè‹¥å­˜åœ¨ç©ºé—²çº¿ç¨‹åˆ™è°ƒç”¨çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Œå½“æŒ‡å®šçš„ä»»åŠ¡å®Œæˆåï¼Œçº¿ç¨‹å°†è‡ªåŠ¨è¿”å›çº¿ç¨‹æ± ï¼›è‹¥ä¸å­˜åœ¨ç©ºé—²çº¿ç¨‹ï¼Œåˆ™å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚</p><p>ä¼˜åŒ–æ€è·¯ï¼šæˆ‘ä»¬ä½•ä¸å°†æ·»åŠ è®¢å•çš„è¿‡ç¨‹äº¤ç»™å¦ä¸€äº›çº¿ç¨‹å»å®Œæˆï¼Œå°†åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒæ·»åŠ è®¢å•çš„åŒæ—¶ï¼Œä¸ºå¦å¤–ä¸€äº›ç”¨æˆ·æ·»åŠ è®¢å•ï¼Œåˆ¤æ–­å’Œæ·»åŠ è¿‡ç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œè¿™æ ·æ•ˆç‡æ˜æ˜¾æ›´é«˜ã€‚æˆ‘ä»¬å°†æœ‰æƒæ·»åŠ è®¢å•çš„è®¢å•ä¿¡æ¯ä¿å­˜åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åå†åˆ©ç”¨çº¿ç¨‹æ± åˆ›å»ºä¸€äº›çº¿ç¨‹ä¸æ–­è·å–é˜»å¡é˜Ÿåˆ—ä¸­çš„è®¢å•ï¼Œè¿™æ ·ä¸€æ¥å°±å®ç°äº†å¼‚æ­¥è¿‡ç¨‹ã€‚</p></blockquote><p><a href="https://blog.csdn.net/qq_41191715/article/details/106480398">é˜»å¡é˜Ÿåˆ—è¯¦ç»†ä»‹ç»-CSDNåšå®¢</a></p><p><a href="https://cloud.tencent.com/developer/article/2369744">ä¸€æ–‡å¸¦ä½ å½»åº•å¼„æ‡‚çº¿ç¨‹æ± -è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘</a></p><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250726012932391.png" alt="image-20250726012932391"></p><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream:order&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸æ–­æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–è®¢å•</span></span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">// 2.åˆ›å»ºè®¢å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;è®¢å•è·å–å¤±è´¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">IVoucherOrderService proxy;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> result.intValue();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="comment">// 4.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">voucherId</span> <span class="operator">=</span> voucherOrder.getVoucherId();</span><br><span class="line">    <span class="comment">// 2.åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">// 3.å°è¯•è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span><br><span class="line">        log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        proxy.createSeckillVoucher(voucherOrder);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createSeckillVoucher</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">voucherId</span> <span class="operator">=</span> voucherOrder.getVoucherId();</span><br><span class="line">    <span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">// å°è¯•è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span></span><br><span class="line">        log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 5.1.æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">// set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>) <span class="comment">// where id = ? and stock &gt; 0</span></span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">            log.error(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥ä¼˜åŒ–</h1><blockquote><p>åœ¨ä½¿ç”¨é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œå¦‚æœå…¥é˜Ÿçš„å…ƒç´ è¿‡å¤šå¯èƒ½å¯¼è‡´jvmå´©æºƒï¼Œå› ä¸ºé˜»å¡é˜Ÿåˆ—éœ€è¦å ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´ï¼ˆè¿™é‡Œçš„å†…å­˜ç©ºé—´ä¸æ˜¯æŒ‡å…¨éƒ¨çš„å†…å­˜ï¼Œè€Œæ˜¯åˆ†é…ç»™jvmçš„é‚£ä¸€éƒ¨åˆ†å†…å­˜ï¼‰ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„ã€‚é‚£æˆ‘ä»¬æœ‰æ²¡æœ‰å¦ä¸€ç§å·¥å…·æ¥ä»£æ›¿é˜»å¡é˜Ÿåˆ—å‘¢ï¼Ÿ</p><p>æ¶ˆæ¯é˜Ÿåˆ—ä¸é˜»å¡é˜Ÿåˆ—ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ¯”é˜»å¡é˜Ÿåˆ—çš„åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œä¸‹é¢æ˜¯ä»–ä»¬ä¸¤çš„ç®€å•å¯¹æ¯”ã€‚</p></blockquote><table><thead><tr><th>ç‰¹æ€§</th><th>é˜»å¡é˜Ÿåˆ— (Blocking Queue)</th><th>æ¶ˆæ¯é˜Ÿåˆ— (Message Queue)</th></tr></thead><tbody><tr><td><strong>å®šä½ä¸å±‚çº§</strong></td><td><strong>çº¿ç¨‹çº§åŒæ­¥æœºåˆ¶</strong>ï¼Œå±äºå¹¶å‘ç¼–ç¨‹å·¥å…·</td><td><strong>ç³»ç»Ÿ/è¿›ç¨‹é—´é€šä¿¡ä¸­é—´ä»¶</strong>ï¼Œå±äºåˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€è®¾æ–½</td></tr><tr><td><strong>ä¸»è¦ç›®çš„</strong></td><td>åè°ƒ<strong>åŒä¸€è¿›ç¨‹å†…å¤šçº¿ç¨‹</strong>é—´çš„æ•°æ®äº¤æ¢</td><td>å®ç°<strong>ä¸åŒè¿›ç¨‹/æœåŠ¡/ç³»ç»Ÿ</strong>é—´çš„å¼‚æ­¥é€šä¿¡ã€è§£è€¦ã€å‰Šå³°å¡«è°·</td></tr><tr><td><strong>æ•°æ®å­˜å‚¨</strong></td><td><strong>å†…å­˜ä¸­</strong>ï¼ˆè¿›ç¨‹é‡å¯æ•°æ®ä¸¢å¤±ï¼‰</td><td><strong>æŒä¹…åŒ–åˆ°ç£ç›˜</strong>ï¼ˆç³»ç»Ÿå´©æºƒå¯æ¢å¤ï¼‰</td></tr><tr><td><strong>é€šä¿¡èŒƒå›´</strong></td><td><strong>å•ä¸€è¿›ç¨‹å†…</strong>çš„çº¿ç¨‹é—´é€šä¿¡</td><td><strong>è·¨è¿›ç¨‹ã€è·¨ä¸»æœºã€è·¨ç½‘ç»œ</strong>çš„åˆ†å¸ƒå¼é€šä¿¡</td></tr><tr><td><strong>é€šä¿¡åè®®</strong></td><td>ç¼–ç¨‹è¯­è¨€APIè°ƒç”¨ï¼ˆå¦‚Javaçš„<code>put()</code>, <code>take()</code>ï¼‰</td><td>ç½‘ç»œåè®®ï¼ˆAMQP, MQTT, Kafkaåè®®ç­‰ï¼‰</td></tr><tr><td><strong>è€¦åˆæ€§</strong></td><td>ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹<strong>ç´§å¯†è€¦åˆ</strong>ï¼ˆéœ€åŒæ—¶åœ¨çº¿ï¼‰</td><td>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…<strong>å®Œå…¨è§£è€¦</strong>ï¼ˆå„è‡ªç‹¬ç«‹è¿è¡Œï¼‰</td></tr><tr><td><strong>å¯é æ€§</strong></td><td><strong>è¾ƒä½</strong>ï¼šæ— æŒä¹…åŒ–/æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</td><td><strong>é«˜</strong>ï¼šæŒä¹…åŒ–ã€ACKæœºåˆ¶ã€é‡è¯•ã€æ­»ä¿¡é˜Ÿåˆ—</td></tr><tr><td><strong>æ‰©å±•æ€§</strong></td><td><strong>å—é™</strong>äºå•æœºèµ„æºï¼ˆå†…å­˜/CPUï¼‰</td><td><strong>é«˜å¯æ‰©å±•</strong>ï¼šæ”¯æŒé›†ç¾¤åŒ–ä¸æ°´å¹³æ‰©å±•</td></tr><tr><td><strong>æŠ€æœ¯å¤æ‚åº¦</strong></td><td>å®ç°ç®€å•ï¼Œè¯­è¨€æ ‡å‡†åº“æä¾›</td><td>æ¶æ„å¤æ‚ï¼Œéœ€ç‹¬ç«‹éƒ¨ç½²è¿ç»´ä¸­é—´ä»¶é›†ç¾¤</td></tr><tr><td><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong></td><td>çº¿ç¨‹æ± ä»»åŠ¡ç¼“å†²ã€é«˜å¹¶å‘è¯·æ±‚å¤„ç†ã€æµæ°´çº¿å¤„ç†</td><td>å¾®æœåŠ¡è§£è€¦ã€äº‹ä»¶é©±åŠ¨æ¶æ„ã€æ—¥å¿—æ”¶é›†ã€æµé‡å‰Šå³°</td></tr><tr><td><strong>å…¸å‹å®ç°</strong></td><td>Java <code>BlockingQueue</code>å®ç°ç±»ï¼ˆå¦‚<code>ArrayBlockingQueue</code>ï¼‰</td><td>RabbitMQ, Kafka, RocketMQ, Amazon SQS</td></tr></tbody></table><blockquote><p>æ¶ˆæ¯é˜Ÿåˆ—ï¼šç®€å•æ¥è¯´æ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯è¿›é˜¶çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¸ä»…å¯ä»¥åœ¨è¿›ç¨‹å†…ä½¿ç”¨ï¼Œè¿˜å¯ä»¥åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ä½¿ç”¨ï¼Œå®ƒæœ€å…·æœ‰æ ‡å¿—çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥é™ä½æ¨¡å—çš„è€¦åˆæ€§ï¼Œä¸€ä¸ªæ¨¡å—å´©æºƒäº†ï¼Œå…¶ä»–æ¨¡å—åŸºæœ¬ä¸ä¼šæ”¶åˆ°æ³¢åŠã€‚æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿæ˜¯åŸºäºç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œä¸è¿‡æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ”¯æŒå¤šç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…çš„ï¼Œä¸€ä»½æ¶ˆæ¯å¯èƒ½è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¥æ”¶å¹¶å¤„ç†ã€‚</p><p>å¯æƒœçš„æ˜¯å®ç°çš„ä»£ç é‡Œå¹¶æ²¡æœ‰ä½“ç°å‡ºæ¶ˆæ¯é˜Ÿåˆ—è¿™äº›ç‰¹ç‚¹ ğŸ˜­ ï¼Œç­‰åšä¸»å­¦æˆå½’æ¥å†å¥½å¥½ç»™å¤§å®¶å” å”  ğŸ‘Š ğŸ‘Š</p></blockquote><p><a href="https://blog.csdn.net/Dean_xiu/article/details/119942872">æ¶ˆæ¯é˜Ÿåˆ—MQå¿«é€Ÿå…¥é—¨-CSDNåšå®¢</a></p><p>å®ç°ä»£ç ï¼š</p><p>åœ¨luaè„šæœ¬ä¸­å¢åŠ è¿™ä¸€æ¡ï¼Œå…¶ä»–ä»£ç åŸºæœ¬ä¸Šåªæœ‰ä»»åŠ¡å®ç°ä¸Šæœ‰æ”¹å˜ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ...</span></span><br><span class="line">redis.call(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream:order&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸æ–­æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS streams.order ?</span></span><br><span class="line">            List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                    StreamOffset.create(queueName, ReadOffset.lastConsumed())</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 2.åˆ¤æ–­æ¶ˆæ¯è·å–æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span>(list == <span class="literal">null</span> || list.isEmpty())&#123;</span><br><span class="line">                <span class="comment">// 2.1.è·å–å¤±è´¥ï¼Œåˆ™è¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.è§£ææ¶ˆæ¯</span></span><br><span class="line">            MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">            Map&lt;Object, Object&gt; values = record.getValue();</span><br><span class="line">            <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">// 4.ä¸‹å•</span></span><br><span class="line">            handleVoucherOrder(voucherOrder);</span><br><span class="line">            <span class="comment">// 5.ACKç¡®è®¤</span></span><br><span class="line">            stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                        Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                        StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                        StreamOffset.create(<span class="string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">if</span> (list == <span class="literal">null</span> || list.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£ææ•°æ®</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; value = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                createSeckillVoucher(voucherOrder);</span><br><span class="line">                <span class="comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(<span class="string">&quot;s1&quot;</span>, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„Ÿè°¢è§‚çœ‹ â¤ï¸ â¤ï¸</p>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸šåŠ¡åŠŸèƒ½--ä¼˜æƒ åˆ¸ç§’æ€(åŸºç¡€)</title>
      <link href="/2025/07/21/2025.7.21/"/>
      <url>/2025/07/21/2025.7.21/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>æœ€è¿‘å­¦ä¹ äº†åˆ©ç”¨redisè§£å†³è®¸å¤šä¸šåŠ¡é—®é¢˜çš„æ–¹æ³•ï¼Œä¼˜æƒ åˆ¸ç§’æ€æ˜¯å…¶ä¸­ä¸€ä¸ªç»¼åˆæ€§è¾ƒå¼ºçš„ä¸šåŠ¡é—®é¢˜ã€‚</p><h1>å…¨å±€å”¯ä¸€id</h1><blockquote><p>é›ªèŠ±ç®—æ³•ï¼šé›ªèŠ±ç®—æ³•çš„åŸç†å°±æ˜¯ç”Ÿæˆä¸€ä¸ªçš„ 64 ä½æ¯”ç‰¹ä½çš„ long ç±»å‹çš„å”¯ä¸€ idã€‚idç»„æˆä¸ºç¬¦å·ä½ï¼ˆ1bitï¼‰ã€æ—¶é—´æˆ³ï¼ˆ41bitsï¼‰ã€å·¥ä½œæœºå™¨IDï¼ˆ10bitsï¼‰ã€åºåˆ—å·ï¼ˆ12bitsï¼‰ã€‚é›ªèŠ±ç®—æ³•èƒ½åŸºäºæ—¶é—´æˆ³ç”Ÿæˆè‡ªå¢çš„idï¼Œä½†æ­£æ˜¯å› ä¸ºåŸºäºæ—¶é—´æˆ³ï¼Œé›ªèŠ±ç®—æ³•æœ‰å¯èƒ½å‡ºç°æ—¶é—´ï¼ˆæ—¶é’Ÿï¼‰å›æ‹¨çš„é—®é¢˜ã€‚</p><p>ç»„æˆï¼š</p><p>1ï¼šæœ€é«˜ 1 ä½æ˜¯ç¬¦å·ä½ï¼Œå›ºå®šå€¼ 0ï¼Œè¡¨ç¤ºid æ˜¯æ­£æ•´æ•°<br>41ï¼šæ¥ä¸‹æ¥ 41 ä½å­˜å‚¨æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œ2^41/(1000606024365)=69ï¼Œå¤§æ¦‚å¯ä»¥ä½¿ç”¨ 69 å¹´ã€‚<br>10ï¼šå†æ¥ä¸‹ 10 ä½å­˜å‚¨æœºå™¨ç ï¼ŒåŒ…æ‹¬ 5 ä½ datacenterId å’Œ 5 ä½ workerIdã€‚æœ€å¤šå¯ä»¥éƒ¨ç½² 2^10=1024 å°æœºå™¨ã€‚<br>12ï¼šæœ€å 12 ä½å­˜å‚¨åºåˆ—å·ã€‚åŒä¸€æ¯«ç§’æ—¶é—´æˆ³æ—¶ï¼Œé€šè¿‡è¿™ä¸ªé€’å¢çš„åºåˆ—å·æ¥åŒºåˆ†ã€‚å³å¯¹äºåŒä¸€å°æœºå™¨è€Œè¨€ï¼ŒåŒä¸€æ¯«ç§’æ—¶é—´æˆ³ä¸‹ï¼Œå¯ä»¥ç”Ÿæˆ 2^12=4096 ä¸ªä¸é‡å¤ idã€‚</p></blockquote><p>åŸºäºé›ªèŠ±ç®—æ³•ç”Ÿæˆidï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é›ªèŠ±ç®—æ³•åˆ†å¸ƒå¼IDç”Ÿæˆå™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç»“æ„ï¼š</span></span><br><span class="line"><span class="comment"> * 0 - 41ä½æ—¶é—´æˆ³ - 10ä½å·¥ä½œæœºå™¨ID - 12ä½åºåˆ—å·</span></span><br><span class="line"><span class="comment"> * æ€»è®¡64ä½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowflakeIdGenerator</span> &#123;</span><br><span class="line">    <span class="comment">// èµ·å§‹æ—¶é—´æˆ³ï¼ˆ2023-01-01 00:00:00 UTCï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">EPOCH</span> <span class="operator">=</span> <span class="number">1672531200000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœºå™¨IDä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">WORKER_ID_BITS</span> <span class="operator">=</span> <span class="number">10L</span>;</span><br><span class="line">    <span class="comment">// åºåˆ—å·ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SEQUENCE_BITS</span> <span class="operator">=</span> <span class="number">12L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€å¤§æœºå™¨IDï¼ˆ1023ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MAX_WORKER_ID</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; WORKER_ID_BITS);</span><br><span class="line">    <span class="comment">// æœ€å¤§åºåˆ—å·ï¼ˆ4095ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MAX_SEQUENCE</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; SEQUENCE_BITS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ—¶é—´æˆ³å·¦ç§»ä½æ•°ï¼ˆ22ä½ï¼š10ä½æœºå™¨ID + 12ä½åºåˆ—å·ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TIMESTAMP_SHIFT</span> <span class="operator">=</span> WORKER_ID_BITS + SEQUENCE_BITS;</span><br><span class="line">    <span class="comment">// æœºå™¨IDå·¦ç§»ä½æ•°ï¼ˆ12ä½åºåˆ—å·ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">WORKER_ID_SHIFT</span> <span class="operator">=</span> SEQUENCE_BITS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> workerId;      <span class="comment">// å·¥ä½œæœºå™¨ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0L</span>;       <span class="comment">// åºåˆ—å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastTimestamp</span> <span class="operator">=</span> -<span class="number">1L</span>; <span class="comment">// ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ—¶é’Ÿå›æ‹¨å®¹å¿é˜ˆå€¼ï¼ˆ5æ¯«ç§’ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MAX_CLOCK_BACKWARD_MS</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workerId å·¥ä½œæœºå™¨ID (0-1023)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SnowflakeIdGenerator</span><span class="params">(<span class="type">long</span> workerId)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (workerId &lt; <span class="number">0</span> || workerId &gt; MAX_WORKER_ID) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                    String.format(<span class="string">&quot;Worker ID must be between 0 and %d&quot;</span>, MAX_WORKER_ID));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.workerId = workerId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆå”¯ä¸€IDï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 64ä½å”¯ä¸€ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> currentTime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†æ—¶é’Ÿå›æ‹¨</span></span><br><span class="line">        <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> lastTimestamp - timestamp;</span><br><span class="line">            <span class="keyword">if</span> (offset &lt;= MAX_CLOCK_BACKWARD_MS) &#123;</span><br><span class="line">                <span class="comment">// å®¹å¿å°èŒƒå›´å›æ‹¨ï¼Œç­‰å¾…æ—¶é—´è¿½èµ¶</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    wait(offset);</span><br><span class="line">                    timestamp = currentTime();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Clock moved backwards, wait interrupted&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ä¸¥é‡æ—¶é’Ÿå›æ‹¨ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(</span><br><span class="line">                        String.format(<span class="string">&quot;Clock moved backwards. Refusing to generate ID for %d milliseconds&quot;</span>, offset));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒä¸€æ¯«ç§’å†…ç”Ÿæˆ</span></span><br><span class="line">        <span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; MAX_SEQUENCE;</span><br><span class="line">            <span class="comment">// åºåˆ—å·ç”¨å®Œï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’</span></span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;</span><br><span class="line">                timestamp = tilNextMillis(lastTimestamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–°æ¯«ç§’é‡ç½®åºåˆ—å·</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastTimestamp = timestamp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»„åˆID</span></span><br><span class="line">        <span class="keyword">return</span> ((timestamp - EPOCH) &lt;&lt; TIMESTAMP_SHIFT)</span><br><span class="line">                | (workerId &lt;&lt; WORKER_ID_SHIFT)</span><br><span class="line">                | sequence;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">currentTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç­‰å¾…ç›´åˆ°ä¸‹ä¸€æ¯«ç§’</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">tilNextMillis</span><span class="params">(<span class="type">long</span> lastTimestamp)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> currentTime();</span><br><span class="line">        <span class="keyword">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">            timestamp = currentTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»IDè§£ææ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">parseTimestamp</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (id &gt;&gt; TIMESTAMP_SHIFT) + EPOCH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»IDè§£æå·¥ä½œæœºå™¨ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">parseWorkerId</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (id &gt;&gt; WORKER_ID_SHIFT) &amp; MAX_WORKER_ID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»IDè§£æåºåˆ—å·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">parseSequence</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id &amp; MAX_SEQUENCE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ä¼˜æƒ åˆ¸ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å‘å®¢æˆ·ç«¯è¿”å›è®¢å•å·ï¼Œè¿™ä¸ªè®¢å•å·åœ¨sqlä¸­ä½œä¸ºè®¢å•è¡¨çš„ä¸»é”®ï¼Œå¤„äºå®‰å…¨æ€§ç­‰è€ƒè™‘æˆ‘ä»¬ä¸å¸Œæœ›è®¢å•å·åœ¨sqlè¡¨ä¸­ç®€å•çš„è‡ªå¢ã€‚åœ¨redisä¸­ä»¥å­—ç¬¦ä¸²ä¸ºkeyçš„é”®å€¼å¯¹ï¼Œkeyä¸­çš„å­—ç¬¦ä¸²å…·æœ‰ä¸åŒçš„å“ˆå¸Œå€¼ï¼Œä¸”å…¶å€¼æ˜¯è‡ªå¢çš„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹æ€§åˆ¶é€ å…¨å±€å”¯ä¸€idã€‚</p></blockquote><p>åŸºäºredisç”Ÿæˆidç»„æˆå¦‚ä¸‹ï¼š</p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250721175456776.png" alt="image-20250721175456776"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼€å§‹æ—¶é—´æˆ³</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisIdWorker</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> nowSecond - BEGIN_TIMESTAMP;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMMdd&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2.è‡ªå¢é•¿</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + date);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>ç§’æ€ä¸‹å•</h1><blockquote><p>åœ¨ç§’æ€ä¸‹å•è¿™ä¸€åœºæ™¯ä¸‹æˆ‘ä»¬åç«¯éœ€è¦å¤„ç†è®¸å¤šé«˜å¹¶å‘çš„ä¸šåŠ¡é—®é¢˜ï¼Œå¦‚è¶…å–é—®é¢˜ã€ä¸€äººä¸€å•é—®é¢˜ç­‰ã€‚</p></blockquote><p>ä¸»è¦é€»è¾‘æµç¨‹å›¾ï¼š</p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250721190304587.png" alt="image-20250721190304587"></p><p>åŸºç¡€ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">// 7.è¿”å›è®¢å•</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¶…å–é—®é¢˜">è¶…å–é—®é¢˜</h2><blockquote><p>åœ¨å‘æ”¾ä¼˜æƒ åˆ¸çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°å¤šä¸ªç”¨æˆ·åŒæ—¶è¿›å…¥æŠ¢ç¥¨ç¨‹åºï¼Œä¸”ç”±äºå½“æ—¶æ•°æ®åº“ä»æœ‰ä½™ç¥¨æœªæ›´æ–°ï¼Œè¿™ä¼šå¯¼è‡´å–å‡ºçš„ç¥¨ä¸é¢„æƒ³çš„è¦å¤šï¼Œè¿™åœ¨ç”Ÿäº§ç¯å¢ƒæ˜¯ååˆ†å±é™©çš„ï¼Œä¸ºè§£å†³å¹¶å‘é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ‚²è§‚é”ä¸ä¹è§‚é”ä¸¤ç§æ€è·¯ã€‚</p></blockquote><ul><li>æ‚²è§‚é”ï¼šæ‚²è§‚é”è®¤ä¸ºéšæ—¶éƒ½ä¼šæœ‰å…¶ä»–çº¿ç¨‹æŠ¢å èµ„æºï¼Œå½“å‰çº¿ç¨‹è·å–é”åï¼Œå…¶ä»–çº¿ç¨‹å°†æ— æ³•å¯¹æ­£å¸¸è¿è¡Œã€‚</li><li>ä¹è§‚é”ï¼šä¹è§‚é”è®¤ä¸ºä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹æŠ¢å èµ„æºï¼Œå½“å‰çº¿ç¨‹ä¸å…¶ä»–çº¿ç¨‹ä¸ä¼šäº’æ–¥ï¼Œä»–ä»¬å°†æ­£å¸¸è®¿é—®èµ„æºï¼Œä½†æ˜¯åœ¨æ›´æ–°èµ„æºå‰åéƒ½ä¼šè¿›è¡Œä¸€æ¬¡æ¯”è¾ƒï¼Œè‹¥å‰åçš„ç»“æœä¸ä¸€è‡´ï¼Œåˆ™è®¤ä¸ºæœ‰å…¶ä»–çº¿ç¨‹æ›´æ”¹äº†èµ„æºï¼Œå½“å‰çº¿ç¨‹ä¼šè®¤ä¸ºè¯¥æ•°æ®ä¸å¯ç”¨ã€‚</li></ul><p>åŸºäºä¹è§‚é”çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    <span class="comment">//ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜ï¼Œæ²¡é”™åªéœ€è¦å¢åŠ è¿™ä¸ªè¯­å¥å°±å¯ä»¥å®ç°åœ¨æ›´æ–°æ•°æ®å‰å¯¹æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œåªä¸è¿‡è¿™é‡Œæ¯”è¾ƒçš„æ˜¯åº“å­˜æ˜¯å¦ä»æœ‰å‰©ä½™ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨æ›´æ–°å‰è·å–ä¸€æ¬¡è¯¥æ•°æ®ï¼Œç„¶ååœ¨æ›´æ–°æ—¶å†æ¬¡å¯¹è¯¥æ•°æ®è¿›è¡Œè·å–ï¼Œä¸ä¹‹å‰çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒã€‚ä¸è¿‡è¿™ç§æ–¹æ³•å°†å¯¼è‡´å¤§é‡è¯·æ±‚è¢«æ‹’ç»ï¼Œå› ä¸ºåœ¨è¯¥çº¿ç¨‹ä»è·å–åˆ°æ›´æ–°è¿™æ®µæ—¶é—´ï¼Œæœ‰å¾ˆå¤§å¯èƒ½å…¶ä»–çº¿ç¨‹å·²ç»å¯¹è¯¥æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œæ‰€ä»¥å¯ä»¥ä¼˜åŒ–ä¸ºå¯¹å½“å‰å‰©ä½™çš„åº“å­˜è¿›è¡Œåˆ¤æ–­ã€‚</span></span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>).update();</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">// 7.è¿”å›è®¢å•</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸€äººä¸€å•é—®é¢˜">ä¸€äººä¸€å•é—®é¢˜</h2><blockquote><p>æˆ‘ä»¬å¸Œæœ›ä¼˜æƒ åˆ¸çš„ç­–ç•¥æ˜¯ä¸€äººä¸€ç¥¨ï¼Œä¸å…è®¸è´­ä¹°å¤šæ¬¡ã€‚å®ç°çš„æ–¹å¼å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å¯¹æ•°æ®åº“æ›´æ–°å‰æ ¹æ®ç”¨æˆ·idè®¿é—®æ•°æ®åº“ï¼Œå¦‚æœæ²¡æœ‰æŸ¥åˆ°è®°å½•åˆ™è®¤ä¸ºè¯¥ç”¨æˆ·æ˜¯ç¬¬ä¸€æ¬¡è´­ä¹°ä¼˜æƒ åˆ¸ï¼Œåä¹‹åˆ™æ‹’ç»ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.ä¸€äººä¸€å•</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸€ä¸ªè´¦å·åªèƒ½è´­ä¹°ä¸€æ¬¡ä¼˜æƒ åˆ¸&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>).update();</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 7.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 7.1è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 7.2ç”¨æˆ·id</span></span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 7.3ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">// 8.è¿”å›è®¢å•</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å…¶å®ä¸éš¾æƒ³åˆ°ä¸Šè¿°ä»£ç å­˜åœ¨çš„å¹¶å‘é—®é¢˜ï¼Œå¦‚æœæœ‰äººåˆ©ç”¨æ•°æ®åº“å½•å…¥è¯¥è´¦æˆ·ä¿¡æ¯è¿™æ®µæ—¶é—´ï¼Œå¤šæ¬¡è¯·æ±‚ä¼˜æƒ åˆ¸ï¼Œè¿™äº›è¯·æ±‚ä¹Ÿå°†è¢«è§†ä¸ºåˆæ³•ï¼Œå› ä¸ºæ•°æ®åº“ä¸èƒ½æŸ¥è¯¢åˆ°è¯¥ç”¨æˆ·çš„ä¿¡æ¯ã€‚æˆ‘ä»¬åŒæ ·åˆ©ç”¨é”æœºåˆ¶è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¤§è‡´æ€æƒ³å°±æ˜¯åœ¨è¿›è¡Œå†™æ•°æ®æ—¶åŠ ä¸€æŠŠé”ï¼Œå…¶ä»–çº¿ç¨‹çš„è¯·æ±‚å°†è¢«æ‹’ç»ï¼Œè¿™æ ·å°±å¯ä»¥æ”¾å¿ƒçš„æ›´æ–°æ•°æ®åº“ã€‚</p></blockquote><p>åŸºäºæ‚²è§‚é”(synchronized)å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ ¹æ®ç”¨æˆ·idåŠ é”</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// é”æ•´ä¸ªå‡½æ•°æ˜¯ä¸ºäº†ä¿è¯äº‹åŠ¡æäº¤åï¼Œé”æ‰è¢«é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern())&#123;</span><br><span class="line">        <span class="comment">//è·å–å¯¹è±¡çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> createSeckillVoucher(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createSeckillVoucher</span><span class="params">(Long voucherId)</span>&#123;</span><br><span class="line">    <span class="comment">// 5.æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>).update();</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="comment">// æ‰£å‡å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">// 7.è¿”å›è®¢å•</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é›†ç¾¤æœåŠ¡å™¨">é›†ç¾¤æœåŠ¡å™¨</h2><blockquote><p>å…¶å®åˆšåˆšæˆ‘ä»¬æ‰€æœ‰åœºæ™¯éƒ½æ˜¯åœ¨å•æœºæ¨¡å¼ä¸‹è¿›è¡Œçš„ï¼Œç°é˜¶æ®µçš„ä¼ä¸šå¼€å‘ä¸€èˆ¬ä¼šéƒ¨ç½²å¤šå°æœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬çš„é”åªèƒ½åœ¨æœ¬æœºä¸­å¯è§ï¼Œå…¶ä»–æœåŠ¡å™¨æ˜¯çœ‹ä¸åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æ“ä½œæ•°æ®åº“æ—¶ï¼Œå…¶ä»–è¯·æ±‚å¯èƒ½é€šè¿‡å…¶ä»–æœåŠ¡å™¨å»è®¿é—®æ•°æ®åº“ï¼Œè¿™æ ·ä¸€æ¥åˆä¼šå‡ºç°å¹¶å‘é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦å€ŸåŠ©åˆ†å¸ƒå¼é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåˆ†å¸ƒå¼é”æœ‰å¾ˆå¤šå®ç°æ–¹å¼ï¼Œæˆ‘ä»¬é‡‡ç”¨rediså®ç°ã€‚å…¶å®è¿™é‡Œåˆæ¶‰åŠè®¸å¤šå¹¶å‘é—®é¢˜ï¼Œè¯¦ç»†å¯ä»¥å»bç«™ä¸Šçœ‹æ˜¯æ€ä¹ˆä¸€æ­¥æ­¥å®Œå–„åˆ†å¸ƒå¼é”çš„ã€‚</p></blockquote><p><a href="https://www.bilibili.com/video/BV1cr4y1671t?spm_id_from=333.788.videopod.episodes&amp;vd_source=ca2923fecc0a3ef7f9bddb75802bcbb4&amp;p=56">å®æˆ˜ç¯‡-09.åˆ†å¸ƒå¼é”-åŸºæœ¬åŸç†å’Œä¸åŒå®ç°æ–¹å¼å¯¹æ¯”_å“”å“©å“”å“©_bilibili</a></p><p><a href="https://www.runoob.com/lua/lua-basic-syntax.html">Lua åŸºæœ¬è¯­æ³• | èœé¸Ÿæ•™ç¨‹</a></p><p>åŸºäºredisçš„åˆ†å¸ƒå¼é”å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    <span class="type">SimpleRedisLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> lock.tryLock(<span class="number">1200</span>);</span><br><span class="line">    <span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥ï¼Œè¿”å›é”™è¯¯æˆ–é‡è¯•</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œä¸šåŠ¡</span></span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> createSeckillVoucher(voucherId);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>) + <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">        UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">// è·å–é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().</span><br><span class="line">                setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨luaè„šæœ¬</span></span><br><span class="line">        stringRedisTemplate.execute(</span><br><span class="line">                UNLOCK_SCRIPT,</span><br><span class="line">                Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">                ID_PREFIX + Thread.currentThread().getId());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„é”å°±æ˜¯ä¸€ä¸ªå‹‰å¼ºå¯ä»¥ç”¨çš„åˆ†å¸ƒå¼é”äº†ï¼Œå½“ç„¶ä»–ä»ç„¶å­˜åœ¨è®¸å¤šé—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç»§ç»­å­¦ä¹ åŸºäºredissonå®ç°åˆ†å¸ƒå¼é”ã€‚</p><p><a href="https://www.bilibili.com/video/BV1cr4y1671t?spm_id_from=333.788.videopod.episodes&amp;vd_source=ca2923fecc0a3ef7f9bddb75802bcbb4&amp;p=65">å®æˆ˜ç¯‡-18.åˆ†å¸ƒå¼é”-Redissonå¿«é€Ÿå…¥é—¨_å“”å“©å“”å“©_bilibili</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çº¿ç¨‹å˜é‡ã€å…¨å±€å¼‚å¸¸å¤„ç†å™¨</title>
      <link href="/2025/07/12/2025.7.12/"/>
      <url>/2025/07/12/2025.7.12/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>è€ƒå®Œè®¡ç½‘å’Œäººæ™ºåŸºç¡€ï¼Œå¥½åƒå¤§äºŒæµ‘æµ‘å™©å™©å°±è¿™æ ·è¿‡å»äº†ï¼Œåäº†ä¸¤å¤©ç«è½¦å›å®¶ï¼Œè¿™å‡ å¤©é™ä¸‹å¿ƒæ¥æŠŠä¹‹å‰çš„é¡¹ç›®ç»™æ¶ˆåŒ–ä¸€ä¸‹ã€‚</p><h1>çº¿ç¨‹å˜é‡</h1><blockquote><p>æœ‰äº›æ—¶å€™ä¸€ä¸ªçº¿ç¨‹å¯èƒ½åœ¨ä¸åŒçš„ç±»æ–¹æ³•ä¹‹é—´æ¥å›è°ƒç”¨ï¼Œè°ƒç”¨çš„æ—¶å€™å¯èƒ½éœ€è¦é‡å¤æºå¸¦å¤šæ¬¡ç›¸åŒçš„å˜é‡ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¸Œæœ›å°†è¯¥å˜é‡å®šä¹‰ä¸ºå…¨å±€ï¼Œå‡å°‘ç é‡çš„åŒæ—¶é¡¹ç›®ç»“æ„ä¼šæ›´æ¸…æ™°ï¼Œä½†æˆ‘ä»¬çš„é¡¹ç›®ä¸€èˆ¬æ˜¯åœ¨å¤šçº¿ç¨‹é«˜å¹¶å‘åœºæ™¯ä¸‹è¿è¡Œçš„ï¼Œè¿™æ—¶å€™çº¿ç¨‹ä¹‹é—´å¯¹è¿™ä¸ªå˜é‡çš„å®šä¹‰å¯èƒ½å¹¶ä¸ç›¸åŒï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å…¨å±€å˜é‡ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«è¿™ä¸ªå˜é‡ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆçŸ¥é“ä½¿ç”¨çš„æ˜¯ä¸æ˜¯è‡ªå·±å®šä¹‰çš„å˜é‡å‘¢ï¼ŒThreadLocalç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚</p></blockquote><h2 id="ThreadLocalæ˜¯ä»€ä¹ˆ">ThreadLocalæ˜¯ä»€ä¹ˆ</h2><p>ThreadLocalå°±æ˜¯çº¿ç¨‹å˜é‡ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹æ‰€æ‹¥æœ‰ï¼Œå¯¹å…¶ä»–çº¿ç¨‹ä¿æŒéš”ç¦»ã€‚</p><p>å®ƒæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p><p>ç®€å•æ¥è¯´ï¼Œä½ çš„è¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªMapï¼Œè¿™ä¸ªMapå°†ThreadLocalä½œä¸ºkeyå­˜å…¥ï¼Œå…¶ä¸­çš„valueæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯Integerã€Stringç­‰å„ç§ç±»å‹ï¼Œè¿™é‡Œåªæ˜¯å¾ˆç®€å•çš„æè¿°ï¼Œè¯¦ç»†æºç å¯ä»¥çœ‹<a href="https://javaguide.cn/java/concurrent/threadlocal.html">JavaGuideä¸­å…³äºThreadLocalçš„ä»‹ç»</a>ã€‚</p><h2 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocaDemo</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; localVar = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;String&gt;();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="comment">//æ‰“å°å½“å‰çº¿ç¨‹ä¸­æœ¬åœ°å†…å­˜ä¸­æœ¬åœ°å˜é‡çš„å€¼</span></span><br><span class="line">        System.out.println(str + <span class="string">&quot; :&quot;</span> + localVar.get());</span><br><span class="line">        <span class="comment">//æ¸…é™¤æœ¬åœ°å†…å­˜ä¸­çš„æœ¬åœ°å˜é‡</span></span><br><span class="line">        localVar.remove();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                ThreadLocaDemo.localVar.set(<span class="string">&quot;local_A&quot;</span>);</span><br><span class="line">                print(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">                <span class="comment">//æ‰“å°æœ¬åœ°å˜é‡</span></span><br><span class="line">                System.out.println(<span class="string">&quot;after remove : &quot;</span> + localVar.get());</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"> </span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                ThreadLocaDemo.localVar.set(<span class="string">&quot;local_B&quot;</span>);</span><br><span class="line">                print(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;after remove : &quot;</span> + localVar.get());</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">A :local_A</span><br><span class="line">after remove : <span class="literal">null</span></span><br><span class="line">B :local_B</span><br><span class="line">after remove : <span class="literal">null</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure><h2 id="åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨">åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨</h2><blockquote><p>ä»‹ç»ä¸€ç§tokenæŠ€æœ¯å’ŒThreadLocalç»“åˆä½¿ç”¨çš„åœºæ™¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é€šå¸¸å°†ThreadLocalå°è£…èµ·æ¥ï¼Œä½¿å…¶åœ¨é¡¹ç›®ä¸­å…·æœ‰å®é™…æ„ä¹‰ï¼Œè¿™é‡Œæ˜¯å°†ThreadLocalä½œä¸ºä¸€ä¸ªå­˜å‚¨idçš„çº¿ç¨‹å˜é‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setCurrentId</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        threadLocal.set(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getCurrentId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeCurrentId</span><span class="params">()</span> &#123;</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æˆ‘ä»¬å¯ä»¥åœ¨jwtæ ¡éªŒçš„æ—¶å€™å°†ç”¨æˆ·çš„tokenè§£æåå°†idå­˜è¿›å»</span></span><br><span class="line"><span class="comment">//1ã€ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ</span></span><br><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getAdminTokenName());</span><br><span class="line"></span><br><span class="line"><span class="comment">//2ã€æ ¡éªŒä»¤ç‰Œ</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;jwtæ ¡éªŒ:&#123;&#125;&quot;</span>, token);</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">empId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());</span><br><span class="line">    <span class="comment">//å°†idå­˜å‚¨èµ·æ¥</span></span><br><span class="line">    BaseContext.setCurrentId(empId);</span><br><span class="line">    log.info(<span class="string">&quot;å½“å‰å‘˜å·¥idï¼š&quot;</span>, empId);</span><br><span class="line">    <span class="comment">//3ã€é€šè¿‡ï¼Œæ”¾è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="comment">//4ã€ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç </span></span><br><span class="line">    response.setStatus(<span class="number">401</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å¢å‘˜å·¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(EmployeeDTO employeeDTO)</span> &#123;</span><br><span class="line">    <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">    BeanUtils.copyProperties(employeeDTO, employee);</span><br><span class="line"></span><br><span class="line">    employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    employee.setCreateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    employee.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">    employee.setPassword(DigestUtils.md5DigestAsHex(DEFAULT_PASSWORD.getBytes()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™é‡Œä½¿ç”¨äº†ThreadLocalä¸­å­˜å‚¨çš„id</span></span><br><span class="line">    employee.setCreateUser(BaseContext.getCurrentId());</span><br><span class="line">    employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">    employeeMapper.insert(employee);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h1>å…¨å±€å¼‚å¸¸å¤„ç†å™¨</h1><blockquote><p>æœ‰æ—¶å€™å†™é¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨try-catchä¸æ–­å°†å¼‚å¸¸æ•è·ï¼Œè¿™ä¹Ÿæ˜¯å¯¹å¼‚å¸¸çš„ä¸€ç§å¤„ç†æ–¹å¼ï¼Œä½†æ˜¯ç”¨æˆ·åœ¨ä½¿ç”¨çš„æ—¶å€™å‡ºç°é—®é¢˜ï¼Œä»–è‡ªå·±æ˜¯çœ‹ä¸åˆ°å‡ºç°çš„å¼‚å¸¸çš„ï¼Œæˆ‘ä»¬åªæ˜¯æ•è·å¼‚å¸¸å´æ²¡æœ‰è¿›è¡Œå¤„ç†ï¼Œå¦‚æœåœ¨æ¯ä¸€æ¬¡æ•è·ä¸­éƒ½å¯¹å¼‚å¸¸è¿›è¡Œä¸€æ¬¡å¤„ç†ï¼Œå·¥ä½œé‡å°†å˜å¾—å·¨å¤§ï¼ˆé¢å‘å¯¹è±¡å˜ä¸ºé¢å‘å¼‚å¸¸ï¼Œæ€»ä¹‹Springbootå¯¹æ­¤æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„å…¨å±€å¤„ç†å™¨ã€‚SpringBootä¸­ï¼Œ@ControllerAdvice å³å¯å¼€å¯å…¨å±€å¼‚å¸¸å¤„ç†ï¼Œä½¿ç”¨è¯¥æ³¨è§£è¡¨ç¤ºå¼€å¯äº†å…¨å±€å¼‚å¸¸çš„æ•è·ï¼Œæˆ‘ä»¬åªéœ€åœ¨è‡ªå®šä¹‰ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨@ExceptionHandleræ³¨è§£ç„¶åå®šä¹‰æ•è·å¼‚å¸¸çš„ç±»å‹å³å¯å¯¹è¿™äº›æ•è·çš„å¼‚å¸¸è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚</p></blockquote><p>åŸç†å’±ä»¬å…ˆä¸åšè®¨è®ºï¼ˆçº¯ä¸ä¼š</p><blockquote><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å¤„ç†sqlé‡å¤å­—æ®µçš„å¤„ç†å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›ç»™ç”¨æˆ·è¿”å›é‡å¤æé†’</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œå¤„ç†é¡¹ç›®ä¸­æŠ›å‡ºçš„ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•è·ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span><span class="params">(SQLIntegrityConstraintViolationException ex)</span>&#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œå¯ä»¥å°†æ•è·çš„å¼‚å¸¸è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå¼‚å¸¸çš„å½¢å¼æ˜¯è¿™æ ·çš„</span></span><br><span class="line">        <span class="comment">//Duplicate entry &#x27;zhangsi&#x27; for key &#x27;employee.idx_username&#x27;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span>(message!=<span class="literal">null</span> &amp;&amp; message.contains(<span class="string">&quot;Duplicate entry&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œæ˜¯å¯¹å­—ç¬¦ä¸²å¤„ç†ï¼Œè½¬æ¢ä¸ºæé†’ç”¨æˆ·çš„å­—æ®µ</span></span><br><span class="line">            String[] split = message.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> split[<span class="number">2</span>];</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> username + MessageConstant.ALREADY_EXISETS;</span><br><span class="line">            <span class="comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> Result.error(msg);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.error(MessageConstant.UNKNOWN_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒ</p><ul><li><a href="https://javaguide.cn/java/concurrent/threadlocal.html">JavaGuide</a></li><li><a href="https://blog.csdn.net/qq_41107231/article/details/115874974">CSDNå…³äºå…¨å±€å¼‚å¸¸å¤„ç†å™¨</a></li><li><a href="https://blog.csdn.net/u010445301/article/details/111322569">CSDNå…³äºçº¿ç¨‹å˜é‡</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tokenä»¤ç‰ŒæŠ€æœ¯+Interceptorè¿‡æ»¤å™¨</title>
      <link href="/2025/06/29/2025.6.29/"/>
      <url>/2025/06/29/2025.6.29/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><blockquote><p>ç®€å•äº†è§£ä¸€ä¸‹åŸç†ï¼Œé‡ç‚¹çŸ¥é“æ€ä¹ˆç”¨</p></blockquote><p>Tokenï¼šç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…çš„æ ‡è¯†ï¼Œåªæœ‰ç™»å½•æˆåŠŸæ‰èƒ½è·å¾—Tokenï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªæœ‰æºå¸¦Tokençš„è¯·æ±‚æ‰èƒ½è¢«Interceptoræ”¾è¡Œã€‚</p><p>Interceptorï¼šè¿™æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨æŠ€æœ¯ï¼Œå¯ä»¥å°†Interceptorç†è§£ä¸ºä¸€ä¸ªç­›å­ï¼Œåœ¨è¯·æ±‚åˆ°è¾¾æ§åˆ¶å±‚å‰è¿›è¡Œæ‹¦æˆªï¼Œæ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œä¸€å®šæ“ä½œï¼Œæ¯”å¦‚æ‹¦æˆªã€æ”¾è¡Œç­‰ç­‰ã€‚</p><hr><h1>Jwtå¿«é€Ÿå…¥é—¨</h1><h2 id="JwtTokençš„ç»„æˆ">JwtTokençš„ç»„æˆ</h2><ul><li>Header</li></ul><p>æ ‡å¤´ï¼Œä¸€èˆ¬ç”¨æ¥æ ‡è¯†ä»¤ç‰Œç±»å‹å’Œæ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>Payload</li></ul><p>æœ‰æ•ˆè½½è·ï¼Œä¿å­˜è‡ªå®šä¹‰ä¿¡æ¯ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;John Doe&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;admin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1516239022</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>Signature</li></ul><p>ç­¾åï¼Œèåˆäº†Headerå’ŒPayloadï¼Œæ ¹æ®è¾“å…¥çš„secretåŸºäºç­¾åç®—æ³•ç”Ÿæˆè€Œæ¥ï¼Œæ˜¯ä¿è¯tokenä¸è¢«ç¯¡æ”¹ã€‚</p><p>ä¸Šé¢çš„ä¿¡æ¯éƒ½æ˜¯jsonæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ ‡å¤´å’Œè½½è·éƒ¨åˆ†æ˜¯Base64ç¼–ç åç›´æ¥æ„æˆtokençš„å‰ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸‰éƒ¨åˆ†ç”±æ ‡ç­¾ç®—æ³•ã€å¯†é’¥å’Œè¾“å…¥çš„ä¿¡æ¯ï¼ˆHeaderã€Payloadï¼‰å†³å®šã€‚</p><h2 id="Tokençš„åˆ›å»ºä¸éªŒè¯">Tokençš„åˆ›å»ºä¸éªŒè¯</h2><blockquote><p>ä½¿ç”¨jwtæä¾›çš„å·¥å…·åŒ…å¿«é€Ÿç”Ÿæˆä»¤ç‰Œ</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”Ÿæˆjwtä»¤ç‰Œ</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jwtCreate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//è‡ªå®šä¹‰ä¿¡æ¯</span></span><br><span class="line">    Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    claims.put(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;m1kasaz&quot;</span>);</span><br><span class="line">    claims.put(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">            <span class="comment">//å°†è‡ªå®šä¹‰ä¿¡æ¯åŠ å…¥token</span></span><br><span class="line">            .addClaims(claims)</span><br><span class="line">            <span class="comment">//å°†ç­¾åç®—æ³•å’Œå¯†é’¥(åŸºäºbase64ç¼–ç )åŠ å…¥token</span></span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, <span class="string">&quot;bTFrYXNheg==&quot;</span>)</span><br><span class="line">            <span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º å½“å‰æ—¶é—´+1h</span></span><br><span class="line">            .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()+<span class="number">3600</span>*<span class="number">60</span>))</span><br><span class="line">            <span class="comment">//ç”Ÿæˆ</span></span><br><span class="line">            .compact();</span><br><span class="line">    System.out.println(token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è§£æjwtä»¤ç‰Œ</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jwtParse</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°æ›´æ”¹ç”Ÿæˆçš„token</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJtMWthc2F6IiwiZXhwIjoxNzUxMzgyMDQ0fQ.vuyp1XEZv3ncI-F6U63QlRHymG_du_IlETE0ZiVarfE&quot;</span>;</span><br><span class="line">    <span class="comment">//è·å–è‡ªå®šä¹‰ä¿¡æ¯</span></span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">            <span class="comment">//è®¾ç½®å¯†é’¥</span></span><br><span class="line">            .setSigningKey(<span class="string">&quot;bTFrYXNheg==&quot;</span>)</span><br><span class="line">            <span class="comment">//è®¾ç½®éœ€è¦è§£æçš„ä»¤ç‰Œ</span></span><br><span class="line">            .parseClaimsJws(token)</span><br><span class="line">            <span class="comment">//è·å–è‡ªå®šä¹‰ä¿¡æ¯</span></span><br><span class="line">            .getBody();</span><br><span class="line">    System.out.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸€èˆ¬å°†jwtåˆ›å»ºå’ŒéªŒè¯å°è£…ä¸ºå·¥å…·ç±»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jwtUtils</span> &#123;</span><br><span class="line">    <span class="comment">//å¯†é’¥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Key</span> <span class="operator">=</span> <span class="string">&quot;bTFrYXNheg==&quot;</span>;</span><br><span class="line">    <span class="comment">//æŒç»­æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">EXP</span> <span class="operator">=</span> <span class="number">3600</span>*<span class="number">60L</span>;</span><br><span class="line">    <span class="comment">//ä½¿ç”¨çš„ç­¾åç®—æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SignatureAlgorithm</span> <span class="variable">SIGN</span> <span class="operator">=</span> SignatureAlgorithm.HS256;</span><br><span class="line">    <span class="comment">//åˆ›å»ºtoken</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">createToken</span><span class="params">(Map&lt;String, Object&gt; claims)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()+EXP))</span><br><span class="line">                .signWith(SIGN, Key)</span><br><span class="line">                .compact();</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è§£ætoken</span></span><br><span class="line">    <span class="keyword">public</span> Claims <span class="title function_">parseToken</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(Key)</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">        <span class="keyword">return</span> claims;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>Interceptorå¿«é€Ÿå…¥é—¨</h1><blockquote><p>Interceptorç”±springbootæä¾›ï¼ŒåŸºäºAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ€æƒ³çš„è¿‡æ»¤æŠ€æœ¯ã€‚</p></blockquote><h2 id="è‡ªå®šä¹‰Interceptor">è‡ªå®šä¹‰Interceptor</h2><p>æƒ³è¦è‡ªå®šä¹‰ <strong>Interceptor</strong>ï¼Œå¿…é¡»å®ç°HandlerInterceptoræˆ–HandlerInterceptorAdapterç±»ä¸­çš„ä¸€ä¸ªã€‚å¹¶éœ€è¦é‡å†™ä¸‰ä¸ªæ–¹æ³•ä¸­è‡³å°‘ä¸€ä¸ªï¼š</p><div class="note info simple"><p>è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯é»˜è®¤æ–¹æ³•ï¼Œæ—¢å¯ä»¥å®ç°ä¹Ÿå¯ä»¥ä¸å®ç°ã€‚</p></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨è¯·æ±‚åˆ°è¾¾Controlleræ–¹æ³•ä¹‹å‰è¿›è¡Œæ“ä½œï¼Œè¿”å›trueè¡¨ç¤ºæ”¾è¡Œï¼Œè¿”å›falseè¡¨ç¤ºæ‹’ç»</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> HandlerInterceptor.<span class="built_in">super</span>.preHandle(request, response, handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨Controllerå±‚æ–¹æ³•æ‰§è¡Œå®Œåè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•å®ç°ä¸€äº›ä¸å‰ç«¯äº¤äº’çš„è¿‡ç¨‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    HandlerInterceptor.<span class="built_in">super</span>.postHandle(request, response, handler, modelAndView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸€èˆ¬åªç”¨äºä½œèµ„æºå›æ”¶ï¼Œåœ¨å‰ç«¯æ¸²æŸ“äº†ç›¸åº”èµ„æºåæ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    HandlerInterceptor.<span class="built_in">super</span>.afterCompletion(request, response, handler, ex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç”¨äºæ§åˆ¶ç™»å½•è¯·æ±‚çš„è¿‡æ»¤å™¨ç¤ºä¾‹</p><p>ä¸»è¦å®ç°çš„åŠŸèƒ½æ˜¯è§£æjwtä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œåˆæ³•å°±æ”¾è¡Œï¼Œå¦åˆ™æ‹’ç»</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenUserInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;<span class="comment">//jwtçš„é…ç½®ç±»ï¼Œç”¨äºè®°å½•å¯†é’¥ç­‰ä¸ªäººä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¡éªŒjwt</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­å½“å‰æ‹¦æˆªåˆ°çš„æ˜¯Controllerçš„æ–¹æ³•è¿˜æ˜¯å…¶ä»–èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            <span class="comment">//å½“å‰æ‹¦æˆªåˆ°çš„ä¸æ˜¯åŠ¨æ€æ–¹æ³•ï¼Œç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1ã€ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getUserTokenName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2ã€æ ¡éªŒä»¤ç‰Œ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;jwtæ ¡éªŒ:&#123;&#125;&quot;</span>, token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.USER_ID).toString());</span><br><span class="line">            BaseContext.setCurrentId(userId);</span><br><span class="line">            log.info(<span class="string">&quot;å½“å‰ç”¨æˆ·idï¼š&quot;</span>, userId);</span><br><span class="line">            <span class="comment">//3ã€é€šè¿‡ï¼Œæ”¾è¡Œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">//4ã€ä¸é€šè¿‡ï¼Œå“åº”401çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ³¨å†Œè¿‡æ»¤å™¨">æ³¨å†Œè¿‡æ»¤å™¨</h2><blockquote><p>ok,åœ¨çŸ¥é“æ€æ ·åˆ›å»ºinteceptorè¿‡æ»¤å™¨åï¼Œæˆ‘ä»¬æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿ</p><p>å…¶å®AOPå°†è‡ªåŠ¨å¸®æˆ‘ä»¬å®Œæˆè°ƒç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“æ€ä¹ˆæ³¨å†Œä¸€ä¸ªinteceptorè¿‡æ»¤å™¨å°±å¥½äº†ã€‚</p><p>æ³¨å†Œè¿‡ç¨‹å¯ä»¥å€ŸåŠ©Springbootçš„WebMvcConfigureré…ç½®ç±»ï¼Œå¦‚ä¸‹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurationSupport</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ç±»è‡ªåŠ¨æ³¨å…¥</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenAdminInterceptor jwtTokenAdminInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ³¨å†Œè‡ªå®šä¹‰æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;å¼€å§‹æ³¨å†Œè‡ªå®šä¹‰æ‹¦æˆªå™¨...&quot;</span>);</span><br><span class="line">        registry.addInterceptor(jwtTokenAdminInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/admin/**&quot;</span>) <span class="comment">//è¿™ä¸ªæŒ‡å®šäº†è¿‡æ»¤å™¨çš„ä½œç”¨èŒƒå›´</span></span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/admin/employee/login&quot;</span>); <span class="comment">//è¿™ä¸ªæŒ‡å®šè¿‡æ»¤å™¨å°†æ’é™¤çš„è¯·æ±‚è·¯å¾„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://jwt.io/">jwtå®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://blog.csdn.net/Herishwater/article/details/103544342">csdn</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ArrayListåº•å±‚å®ç°</title>
      <link href="/2025/06/27/2025.6.27/"/>
      <url>/2025/06/27/2025.6.27/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>ç¬¬ä¸€æ¬¡è®°å½•æºç æ–‡ç« æ²¡ä»€ä¹ˆç»éªŒï¼Œå¸Œæœ›ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦èƒ½å¸®åŠ©ä½ åŠ æ·±å¯¹javaæ•°æ®ç»“æ„ArrayList(jdk17)çš„ç†è§£ã€‚</p><ul><li><a href="#oringinAnalysis">æºç åˆ†æ</a></li><li><a href="#flowChat">æ‰§è¡Œæµç¨‹å›¾</a></li><li><a href="#face">é¢è¯•é¢˜</a></li></ul><h2 id="æºç åˆ†æ-a-id-oringinAnalysis-a">æºç åˆ†æ<a id = "oringinAnalysis"></a></h2><p>ä¸‹é¢é€šè¿‡æ³¨è§£æ–¹å¼ä¸ºå¤§ä¼™ç®€å•è®²ä¸€ä¸‹åº•å±‚é€»è¾‘</p><h3 id="æ„é€ æ–¹å¼">æ„é€ æ–¹å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractList</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@java</span>.io.Serial</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è¿™æ˜¯åºåˆ—å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8683452581122892189L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ— å‚æ„é€ æ—¶çš„é»˜è®¤å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAPACITY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰ä¸¤ä¸ªç©ºæ•°ç»„ï¼Œç”¨äºåˆ¤æ–­å½“å‰æ•°ç»„çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å…ƒç´ å‚¨å­˜çš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">transient</span> Object[] elementData; </span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“å‰å®¹é‡ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¼ å…¥å‚æ•°ä¸ºintç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ArrayList</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//è‹¥ä¼ å…¥çš„å€¼å¤§äº0ï¼Œåˆ™ä»¥ä¼ å…¥çš„å€¼ä½œä¸ºæ•°ç»„å¤§å°</span></span><br><span class="line">            <span class="built_in">this</span>.elementData = <span class="keyword">new</span> <span class="title class_">Object</span>[initialCapacity];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Illegal Capacity: &quot;</span>+</span><br><span class="line">                                               initialCapacity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ— å‚æ„é€ æ—¶ï¼Œåˆå§‹åŒ–ä¸€ä¸ªç©ºæ•°ç»„ä½¿ç”¨ï¼Œæ³¨æ„ï¼è¿™é‡Œå¹¶æ²¡æœ‰èµ‹äºˆè¯¥æ•°ç»„ä¸€å®šçš„å¤§å°ã€‚</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ArrayList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¼ å…¥å‚æ•°ä¸ºé›†åˆ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> &#123;</span><br><span class="line">        <span class="comment">//å…ˆå°†ä¼ å…¥é›†åˆè½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line">        Object[] a = c.toArray();</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ä¼ å…¥æ˜¯å¦æ˜¯ç©ºé›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> ((size = a.length) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//éç©ºä¸”ä¼ å…¥é›†åˆä¹Ÿæ˜¯ArrayListï¼Œåˆ™ç›´æ¥å°†ä¼ å…¥é›†åˆçš„åœ°å€èµ‹ç»™æˆ‘ä»¬åˆ›å»ºçš„é›†åˆ</span></span><br><span class="line">            <span class="keyword">if</span> (c.getClass() == ArrayList.class) &#123;</span><br><span class="line">                elementData = a;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">/*éç©ºä½†ä¼ å…¥é›†åˆä¸æ˜¯ArrayListï¼Œåˆ™è¿›è¡Œæ•°ç»„çš„æµ…æ‹·è´ï¼Œæ³¨æ„ï¼è¿™é‡Œçš„åªä¼šå°†é›†åˆé‡Œçš„å±æ€§æ”¹å˜è€Œä¸æ”¹å˜å…¶åœ°å€</span></span><br><span class="line"><span class="comment">            ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è‹¥å¯¹ä¼ å…¥çš„é›†åˆè¿›è¡Œæ“ä½œæ˜¯ä¸ä¼šå½±å“æˆ‘ä»¬åˆ›å»ºçš„Listçš„</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                elementData = Arrays.copyOf(a, size, Object[].class);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ’å…¥å…ƒç´ ">æ’å…¥å…ƒç´ </h3><div class="note info simple"><p>æƒ³äº†ä¸€ä¸‹è¿™é‡Œå’Œæ‰©å®¹ä¸€èµ·è®²æ¯”è¾ƒå¥½</p></div><p>å‡ ä¸ªæ’å…¥å…ƒç´ çš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//ä¸€ä¸ªå…¶ä»–æ–¹æ³•çš„è°ƒç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(E e, Object[] elementData, <span class="type">int</span> s)</span> &#123;</span><br><span class="line">       <span class="comment">//åˆ¤æ–­åŸæ¥çš„æ•°ç»„å¤§å°æ˜¯å¦å¤Ÿç”¨</span></span><br><span class="line">       <span class="keyword">if</span> (s == elementData.length)</span><br><span class="line">           <span class="comment">//ä¸å¤Ÿç”¨ï¼Œæ‰©å®¹</span></span><br><span class="line">           elementData = grow();</span><br><span class="line">       <span class="comment">//å¤Ÿç”¨ç›´æ¥æ’å…¥</span></span><br><span class="line">       elementData[s] = e;</span><br><span class="line">       size = s + <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//é›†åˆä¸­æ’å…¥å…ƒç´ </span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">       modCount++;</span><br><span class="line">       <span class="comment">//è°ƒç”¨äº†ä¸Šé¢çš„add()æ–¹æ³•</span></span><br><span class="line">       add(e, elementData, size);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ </span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> index, E element)</span> &#123;</span><br><span class="line">       <span class="comment">//åˆ¤æ–­æ’å…¥çš„ä½ç½®æ˜¯å¦åˆæ³•</span></span><br><span class="line">       rangeCheckForAdd(index);</span><br><span class="line">       modCount++;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">int</span> s;</span><br><span class="line">       Object[] elementData;</span><br><span class="line">       <span class="comment">//åˆ¤æ–­æ•°ç»„æ˜¯å¦å¤Ÿé•¿</span></span><br><span class="line">       <span class="keyword">if</span> ((s = size) == (elementData = <span class="built_in">this</span>.elementData).length)</span><br><span class="line">           <span class="comment">//ä¸å¤Ÿé•¿æ‰©å®¹</span></span><br><span class="line">           elementData = grow();</span><br><span class="line">       <span class="comment">//æ”¹å˜å…¶ä»–å…ƒç´ çš„ä½ç½®ï¼Œå°±æ˜¯å°†è¯¥ä¸‹æ ‡åçš„æ‰€æœ‰å…ƒç´ æ‹·è´åˆ°è¯¥ä¸‹æ ‡+1ä½ç½®å</span></span><br><span class="line">       System.arraycopy(elementData, index,</span><br><span class="line">                        elementData, index + <span class="number">1</span>,</span><br><span class="line">                        s - index);</span><br><span class="line">       <span class="comment">//æ’å…¥å…ƒç´ </span></span><br><span class="line">       elementData[index] = element;</span><br><span class="line">       size = s + <span class="number">1</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸‹é¢æ˜¯æ‰©å®¹æ“ä½œï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> Object[] grow(<span class="type">int</span> minCapacity) &#123;</span><br><span class="line">       <span class="comment">//è®°å½•è€å®¹é‡</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> elementData.length;</span><br><span class="line">       <span class="comment">//å¦‚æœå¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰©å®¹</span></span><br><span class="line">       <span class="keyword">if</span> (oldCapacity &gt; <span class="number">0</span> || elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class="line">           <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> ArraysSupport.newLength(oldCapacity,</span><br><span class="line">                   minCapacity - oldCapacity, <span class="comment">/*æœ€å°æ‰©å®¹é‡ minimum growth */</span></span><br><span class="line">                   oldCapacity &gt;&gt; <span class="number">1</span>           <span class="comment">/*é¦–é€‰å¢é•¿é‡ preferred growth */</span>);</span><br><span class="line">           <span class="type">return</span> <span class="variable">elementData</span> <span class="operator">=</span> Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//ç¬¬ä¸€æ¬¡æ‰©å®¹è‡³é»˜è®¤å®¹é‡10</span></span><br><span class="line">           <span class="type">return</span> <span class="variable">elementData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>[Math.max(DEFAULT_CAPACITY, minCapacity)];</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Object[] grow() &#123;</span><br><span class="line">       <span class="keyword">return</span> grow(size + <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">newLength</span><span class="params">(<span class="type">int</span> oldLength, <span class="type">int</span> minGrowth, <span class="type">int</span> prefGrowth)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">int</span> <span class="variable">prefLength</span> <span class="operator">=</span> oldLength + Math.max(minGrowth, prefGrowth); <span class="comment">// might overflow</span></span><br><span class="line">       <span class="comment">//å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œå°±å°†ä¸¤å€çš„è€å®¹é‡ç›´æ¥è¿”å›</span></span><br><span class="line">       <span class="comment">//SOFT_MAX_ARRAY_LENGTH = INTEGER_MAX-8</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="number">0</span> &lt; prefLength &amp;&amp; prefLength &lt;= SOFT_MAX_ARRAY_LENGTH) &#123;</span><br><span class="line">           <span class="keyword">return</span> prefLength;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> hugeLength(oldLength, minGrowth);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//è¿™ä¸ªæ–¹æ³•ä¸ç”¨ç»†çœ‹ï¼Œåªè¦çŸ¥é“æœ€å¤§é•¿åº¦æ˜¯INTEGER_MAXå°±è¡Œ</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hugeLength</span><span class="params">(<span class="type">int</span> oldLength, <span class="type">int</span> minGrowth)</span> &#123;</span><br><span class="line">       <span class="type">int</span> <span class="variable">minLength</span> <span class="operator">=</span> oldLength + minGrowth;</span><br><span class="line">       <span class="keyword">if</span> (minLength &lt; <span class="number">0</span>) &#123; </span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OutOfMemoryError</span>(</span><br><span class="line">               <span class="string">&quot;Required array length &quot;</span> + oldLength + <span class="string">&quot; + &quot;</span> + minGrowth + <span class="string">&quot; is too large&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (minLength &lt;= SOFT_MAX_ARRAY_LENGTH) &#123;</span><br><span class="line">           <span class="keyword">return</span> SOFT_MAX_ARRAY_LENGTH;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> minLength;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°ç»„è½¬List">æ•°ç»„è½¬List</h3><div class="note info simple"><p>æ”¹å˜æ•°ç»„ä¼šå½±å“List</p></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™æ˜¯å°†arrayçš„åœ°å€ç›´æ¥ä¼ ç»™äº†a</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">asList</span><span class="params">(T... a)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(a);</span><br><span class="line">   &#125;</span><br><span class="line">   ArrayList(E[] array) &#123;</span><br><span class="line">       <span class="comment">//è¿™ä¸ªæ–¹æ³•ç”¨æ¥è·å–æ•°ç»„çš„åœ°å€</span></span><br><span class="line">       a = Objects.requireNonNull(array);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="Listè½¬æ•°ç»„">Listè½¬æ•°ç»„</h3><div class="note info simple"><p>æ”¹å˜Listä¸ä¼šå½±å“æ•°ç»„</p></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//è¿™é‡Œå¾ˆæ˜æ˜¾æ˜¯è¿›è¡Œäº†ä¸€æ¬¡æ‹·è´è€Œä¸æ˜¯åœ°å€ä¼ é€’</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Object[] toArray() &#123;</span><br><span class="line">       <span class="keyword">return</span> Arrays.copyOf(a, a.length, Object[].class);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="æµç¨‹å›¾-a-id-flowChat-a">æµç¨‹å›¾<a id = "flowChat"></a></h2><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250628230220153.png" alt="image-20250628230220153"></p><hr><h2 id="é¢è¯•é¢˜-a-id-face-a">é¢è¯•é¢˜<a id = "face"></a></h2><ul><li><strong>ArrayListåº•å±‚çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ</strong></li></ul><p>ArrayListåº•å±‚æ˜¯ç”¨åŠ¨æ€çš„æ•°ç»„å®ç°çš„ã€‚<br>ArrayListåˆå§‹å®¹é‡ä¸º0ï¼Œå½“ç¬¬ä¸€æ¬¡æ·»åŠ æ•°æ®çš„æ—¶å€™æ‰ä¼šåˆå§‹åŒ–å®¹é‡ä¸º10ã€‚<br>ArrayListåœ¨è¿›è¡Œæ‰©å®¹çš„æ—¶å€™æ˜¯åŸæ¥å®¹é‡çš„2å€ï¼Œæ¯æ¬¡æ‰©å®¹éƒ½éœ€è¦æ‹·è´æ•°ç»„ã€‚<br>ArrayListåœ¨æ·»åŠ æ•°æ®çš„æ—¶å€™ã€‚<br>ç¡®ä¿æ•°ç»„å·²ä½¿ç”¨é•¿åº¦ï¼ˆsizeï¼‰åŠ 1ä¹‹åè¶³å¤Ÿå­˜ä¸‹ä¸‹ä¸€ä¸ªæ•°æ®ã€‚<br>è®¡ç®—æ•°ç»„çš„å®¹é‡ï¼Œå¦‚æœå½“å‰æ•°ç»„å·²ä½¿ç”¨é•¿åº¦+1åçš„å¤§äºå½“å‰çš„æ•°ç»„é•¿åº¦ï¼Œåˆ™è°ƒç”¨growæ–¹æ³•æ‰©å®¹ï¼ˆåŸæ¥çš„2å€)ã€‚<br>ç¡®ä¿æ–°å¢çš„æ•°æ®æœ‰åœ°æ–¹å­˜å‚¨ä¹‹åï¼Œåˆ™å°†æ–°å…ƒç´ æ·»åŠ åˆ°ä½äºsizeçš„ä½ç½®ä¸Šã€‚<br>è¿”å›æ·»åŠ æˆåŠŸå¸ƒå°”å€¼ã€‚</p><ul><li><p><strong>å¦‚ä½•å®ç°Listå’Œæ•°ç»„ä¹‹é—´çš„è½¬æ¢(å¯å‚è€ƒå®ç°åŸç†)</strong></p></li><li><p><strong>ArrayListå’ŒLinkedListçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</strong></p></li></ul><p>åº•å±‚æ•°æ®ç»“æ„ï¼š</p><p>ArrayListæ˜¯åŸºäºåŠ¨æ€æ•°ç»„ï¼ˆæ—¶é—´ã€ç©ºé—´ï¼‰</p><p>LinkedListæ˜¯åŸºäºåŒå‘é“¾è¡¨ï¼ˆæ—¶é—´ã€ç©ºé—´ï¼‰</p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlè¯­å¥çš„æ‰§è¡Œé€»è¾‘</title>
      <link href="/2025/06/25/2025.6.25/"/>
      <url>/2025/06/25/2025.6.25/</url>
      
        <content type="html"><![CDATA[<h2 id="Mysqlçš„æ¶æ„">Mysqlçš„æ¶æ„</h2><p>ç®€å•æ¥è¯´Mysqlåˆ†ä¸ºServerå±‚å’Œå­˜å‚¨å¼•æ“å±‚ã€‚</p><h3 id="Serverå±‚">Serverå±‚</h3><p><strong>ä¸»è¦åŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ï¼Œå‡½æ•°ç­‰ï¼Œè¿˜æœ‰ä¸€ä¸ªé€šç”¨çš„æ—¥å¿—æ¨¡å— binlog æ—¥å¿—æ¨¡å—ã€‚</strong></p><ul><li>è¿æ¥å™¨ï¼šèº«ä»½è®¤è¯å’Œæƒé™åˆ†æã€‚</li><li>ç¼“å­˜ï¼ˆMysql8.0ä¸­ç§»é™¤ï¼‰ï¼šå°†è¿‘æœŸæŸ¥è¯¢ç»“æœå‚¨å­˜ä¸‹æ¥ï¼ŒåŠ å¿«æŸ¥è¯¢æ•ˆç‡ã€‚</li><li>åˆ†æå™¨ï¼šè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æã€‚</li><li>ä¼˜åŒ–å™¨ï¼šä¼˜åŒ–æŸ¥è¯¢è·¯å¾„ã€‚</li><li>æ‰§è¡Œå™¨ï¼šæ‰§è¡Œè¯­å¥å’Œè¿”å›ç»“æœã€‚</li></ul><p>ï¼ˆæ¶æ„å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼‰</p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/mmexport1750848916079.png" alt="mmexport1750848916079"></p><h3 id="å­˜å‚¨å¼•æ“å±‚">å­˜å‚¨å¼•æ“å±‚</h3><p><strong>ä¸»è¦è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œè¯»å–ï¼Œé‡‡ç”¨å¯ä»¥æ›¿æ¢çš„æ’ä»¶å¼æ¶æ„ï¼Œæ”¯æŒ InnoDBã€MyISAMã€Memory ç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ï¼Œå…¶ä¸­ InnoDB å¼•æ“æœ‰è‡ªæœ‰çš„æ—¥å¿—æ¨¡å— redolog æ¨¡å—ã€‚ç°åœ¨æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯ InnoDBï¼Œå®ƒä» MySQL 5.5 ç‰ˆæœ¬å¼€å§‹å°±è¢«å½“åšé»˜è®¤å­˜å‚¨å¼•æ“äº†ã€‚</strong></p><hr><h2 id="è¯­å¥åˆ†æ">è¯­å¥åˆ†æ</h2><p>Mysqlçš„è¯­å¥åˆ†ä¸ºæŸ¥è¯¢ä¸æ›´æ–°ï¼ˆå¢åˆ æ”¹ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where id = 1 and name = &quot;å¼ ä¸‰&quot;</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸€æ¡æŸ¥è¯¢è¯­å¥ï¼ŒMysqlçš„æ‰§è¡Œæµç¨‹å¯ä»¥è¿™æ ·è§£é‡Šï¼šåœ¨è¯­å¥åˆ†æå‰ï¼Œè¿æ¥å™¨å°±ä¼šå¯¹ç”¨æˆ·è¿›è¡Œæƒé™åˆ†æï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ‰§è¡Œè¯¥è¯­å¥çš„æƒåŠ›ï¼Œç„¶åç¨‹åºå°†è®¿é—®ç¼“å­˜ï¼ˆMysql8.0ç‰ˆæœ¬å‰ï¼‰ï¼ŒæŸ¥è¯¢è¯­å¥çš„å¯¹åº”ç»“æœï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰å¯¹åº”çš„Key-Valueï¼Œåˆ†æå™¨å°†å¯¹ç¨‹åºè¿›è¡Œè¯æ³•åˆ†æï¼Œæå–å¦‚<strong>whereï¼Œselect</strong>ç­‰å…³é”®è¯ä¸<strong>è¡¨åï¼Œå­—æ®µå</strong>ç­‰ä¿¡æ¯ï¼Œè¯­æ³•åˆ†æå°†å¯¹è¯¥è¯­å¥çš„è¯­æ³•è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥è¯­æ³•æ­£ç¡®ï¼Œç¨‹åºå°†æŒ‰ç…§ä¼˜åŒ–å™¨ç»™å‡ºçš„æœ€ä½³è·¯å¾„**ï¼ˆè¿™é‡Œçš„æœ€ä½³è·¯å¾„åªæ˜¯ä¼˜åŒ–å™¨è®¤ä¸ºçš„æœ€ä½³ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„ï¼Œå¯¹äºä¸Šé¢è¿™ä¸€æ¡ä¸€å¥ï¼Œç¨‹åºæ—¢æœ‰å¯èƒ½å…ˆå¯¹idå­—æ®µæŸ¥è¯¢ï¼Œä¹Ÿæœ‰å¯èƒ½å…ˆå¯¹nameå­—æ®µæŸ¥è¯¢ï¼‰**æ‰§è¡ŒæŸ¥è¯¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set id = 1 where id = 2</span><br></pre></td></tr></table></figure><p>å¯¹äºè¿™ä¸€æ¡æ›´æ–°è¯­å¥ï¼Œæµç¨‹å¤§ä½“ä¸æŸ¥è¯¢è¯­å¥ç›¸ä¼¼ï¼Œç”±äºæ¶‰åŠå¯¹æ•°æ®åº“è¡¨çš„æ›´æ–°ï¼Œæ›´æ–°è¯­å¥ä¸ä¼šè®¿é—®ç¼“å­˜ã€‚æ›´æ–°è¯­å¥å°†æ¶‰åŠæ—¥å¿—æ¨¡å—ï¼ŒMysqlè‡ªå¸¦çš„æ—¥å¿—æ¨¡å—æ˜¯<strong>binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰</strong>ï¼Œæ‰€æœ‰çš„å­˜å‚¨å¼•æ“éƒ½å¯ä½¿ç”¨ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„<strong>InnoDB</strong>è¿˜è‡ªå¸¦ä¸€ä¸ª**redologï¼ˆé‡åšæ—¥å¿—ï¼‰**æ¨¡å—ï¼Œä¸‹é¢å°†ä»¥InnoDBå¼•æ“è®¨è®ºç¨‹åºæ‰§è¡Œæµç¨‹ã€‚</p><p>æŸ¥è¯¢åˆ°idä¸º2è¿™ä¸€æ¡å­—æ®µåï¼Œå°†idè®¾ç½®ä¸º1ï¼Œç„¶åè°ƒç”¨<strong>InnoDB</strong>çš„APIæ¥å£å†™å…¥è¿™ä¸€æ¡æ•°æ®ï¼Œç„¶åå‘Šè¯‰æ‰§è¡Œå™¨å®Œæˆæ‰§è¡Œï¼Œå¼•æ“å°†è°ƒç”¨<strong>redolog</strong>å°†å…¶è®¾ç½®ä¸º<strong>prepareå°±ç»ªçŠ¶æ€</strong>ï¼Œæ‰§è¡Œå™¨è®°å½•binlogæ—¥å¿—åå‘ŠçŸ¥å¼•æ“è®¾ç½®<strong>redologä¸ºæäº¤çŠ¶æ€</strong>ï¼Œæ›´æ–°å®Œæˆã€‚</p><hr><ul><li><a href="https://dev.mysql.com/doc/refman/8.4/en/">Mysqlå®˜æ–¹å‚è€ƒæ‰‹å†Œ</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> é¢è¯•é¢˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå¤šçº¿ç¨‹ä¸­wait/notifyæœºåˆ¶</title>
      <link href="/2025/06/24/2025.6.24/"/>
      <url>/2025/06/24/2025.6.24/</url>
      
        <content type="html"><![CDATA[<h3 id="wait-notifyæœºåˆ¶">wait/notifyæœºåˆ¶</h3><ul><li>wait():åœ¨è·å¾—å¯¹è±¡é”åä¸»åŠ¨è¿›å…¥ç­‰å¾…çŠ¶æ€è®©å‡ºå¯¹è±¡é”ã€‚</li><li>notify():åŒæ ·æ—¶é€šçŸ¥æ­£åœ¨ç­‰å¾…çš„å…¶ä»–çº¿ç¨‹ï¼Œä¸»åŠ¨è®©å‡ºå¯¹è±¡é”ï¼Œä½†æ˜¯ï¼Œä¸ wait() æ–¹æ³•ä¸åŒï¼Œæ‰§è¡Œ notify() åï¼Œä¸ä¼šç«‹å³é‡Šæ”¾å¯¹è±¡é”ï¼Œè€Œéœ€è¦æ‰§è¡Œå®Œ synchronize çš„ä»£ç å—æˆ–æ–¹æ³•æ‰ä¼šé‡Šæ”¾é”ï¼Œæ‰€ä»¥æ¥æ”¶é€šçŸ¥çš„çº¿ç¨‹ä¹Ÿä¸ä¼šç«‹å³è·å¾—é”ï¼Œä¹Ÿéœ€è¦ç­‰å¾…æ‰§è¡Œ notify() æ–¹æ³•çš„çº¿ç¨‹é‡Šæ”¾é”åå†è·å–é”ã€‚</li></ul><h3 id="åº”ç”¨">åº”ç”¨</h3><div class="note info simple"><p>é—®é¢˜ï¼šå†™ä¸¤ä¸ªçº¿ç¨‹æ‰“å°1-100ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰“å°å¥‡æ•°ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰“å°å¶æ•°</p></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Printer</span> &#123;</span><br><span class="line">    <span class="comment">//æ‰“å°çš„æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> max;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®šä¹‰å¯¹è±¡é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printEven</span><span class="params">()</span>&#123;</span><br><span class="line">        print(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printOdd</span><span class="params">()</span>&#123;</span><br><span class="line">        print(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Printer</span><span class="params">(<span class="type">int</span> max)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.max = max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(<span class="type">boolean</span> isOdd)</span>&#123;</span><br><span class="line">        <span class="comment">//æ¯ä¸ªçº¿ç¨‹å„æ‰§è¡Œ50æ¬¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= max; i+=<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">//åŠ é”</span></span><br><span class="line">            <span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­å½“å‰æ˜¯è½®åˆ°å“ªä¸ªçº¿ç¨‹æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">while</span> (isOdd == (count%<span class="number">2</span>==<span class="number">0</span>))&#123;</span><br><span class="line">                    <span class="comment">//è‹¥ä¸æ˜¯å½“å‰çº¿ç¨‹æ‰§è¡Œæ—¶æœºåˆ™è®©å‡ºé”</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//æ‰“å°</span></span><br><span class="line">                System.out.println(Thread.currentThread().getName()+<span class="string">&quot;: &quot;</span>+count++);</span><br><span class="line">                <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                lock.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Printer</span> <span class="variable">printer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Printer</span>(<span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">odd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(printer::printOdd, <span class="string">&quot;Odd&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">even</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(printer::printEven, <span class="string">&quot;Even&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        odd.start();</span><br><span class="line">        even.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> é¢è¯•é¢˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>watchç›‘å¬å‡½æ•°</title>
      <link href="/2025/06/24/2025.6.23/"/>
      <url>/2025/06/24/2025.6.23/</url>
      
        <content type="html"><![CDATA[<h3 id="å±æ€§ç›‘å¬">å±æ€§ç›‘å¬</h3><ul><li><p>æºå¯¹è±¡æ˜¯ä¸€ä¸ªrefçš„å±æ€§å€¼åŠå…¶è¡ç”Ÿå¼</p></li><li><p>å½“ç›‘å¬çš„å±æ€§å€¼å‘ç”Ÿå˜åŒ–æ—¶ä¼šè§¦å‘ç›‘å¬å‡½æ•°æ‰§è¡Œå“åº”çš„æ“ä½œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> x = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> y = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å•ä¸ª ref</span></span><br><span class="line"><span class="title function_">watch</span>(x, <span class="function">(<span class="params">newX</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`x is <span class="subst">$&#123;newX&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// getter å‡½æ•°</span></span><br><span class="line"><span class="title function_">watch</span>(</span><br><span class="line">  <span class="function">() =&gt;</span> x.<span class="property">value</span> + y.<span class="property">value</span>,</span><br><span class="line">  <span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`sum of x + y is: <span class="subst">$&#123;sum&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šä¸ªæ¥æºç»„æˆçš„æ•°ç»„</span></span><br><span class="line"><span class="title function_">watch</span>([x, <span class="function">() =&gt;</span> y.<span class="property">value</span>], <span class="function">(<span class="params">[newX, newY]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`x is <span class="subst">$&#123;newX&#125;</span> and y is <span class="subst">$&#123;newY&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="å¯¹è±¡ç›‘å¬">å¯¹è±¡ç›‘å¬</h3><h4 id="1-å¯¹è±¡çš„å…¨éƒ¨å±æ€§">1.å¯¹è±¡çš„å…¨éƒ¨å±æ€§</h4><ul><li>æºå¯¹è±¡æ˜¯ä¸€ä¸ªrefçš„å¯¹è±¡å€¼</li><li>æµ…å±‚ç›‘å¬ï¼šå¯¹refå¯¹è±¡å†…çš„å±æ€§è¿›è¡Œæ›´æ”¹æ—¶ä¸ä¼šè§¦å‘ç›‘å¬</li><li>æ·±å±‚ç›‘å¬ï¼šå½“refå¯¹è±¡å†…ä»»ä¸€å±æ€§å‘ç”Ÿæ›´æ”¹æ—¶éƒ½ä¼šè§¦å‘ï¼Œä½†æ˜¯æ€§èƒ½å¼€é”€æ›´å¤§</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = <span class="title function_">ref</span>(&#123;&#125;)</span><br><span class="line"><span class="title function_">watch</span>(user, <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//è¡Œä¸º</span></span><br><span class="line">&#125;,(<span class="attr">deep</span>:<span class="literal">true</span>)<span class="comment">//å¼€å¯æ·±åº¦ç›‘å¬</span></span><br></pre></td></tr></table></figure><h4 id="2-å¯¹è±¡çš„å•ä¸ªå±æ€§">2.å¯¹è±¡çš„å•ä¸ªå±æ€§</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> searchEmp = <span class="title function_">ref</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">gender</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">date</span>: [],</span><br><span class="line">  <span class="attr">begin</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">end</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¾¦å¬searchEmpä¸­çš„dateå±æ€§</span></span><br><span class="line"><span class="title function_">watch</span>(</span><br><span class="line">  <span class="comment">//è¿™é‡Œéœ€è¦ç”¨ä¸€ä¸ªå¯¹è±¡å±æ€§çš„getteræ–¹æ³•ï¼Œç¦æ­¢å±æ€§å€¼ç›´æ¥ä¼ å…¥</span></span><br><span class="line">  <span class="function">() =&gt;</span> searchEmp.<span class="property">value</span>.<span class="property">date</span>,</span><br><span class="line">  <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="keyword">if</span>(newValue.<span class="property">length</span> == <span class="number">2</span>)&#123;</span><br><span class="line">      searchEmp.<span class="property">value</span>.<span class="property">begin</span> = newValue[<span class="number">0</span>]</span><br><span class="line">      searchEmp.<span class="property">value</span>.<span class="property">end</span> = newValue[<span class="number">1</span>]</span><br><span class="line">     &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      searchEmp.<span class="property">value</span>.<span class="property">begin</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">      searchEmp.<span class="property">value</span>.<span class="property">end</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li><a href="https://cn.vuejs.org/guide/essentials/watchers">å®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VueRouter</title>
      <link href="/2025/06/22/2025.6.22/"/>
      <url>/2025/06/22/2025.6.22/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>VueRouterï¼ˆä»¥ä¸‹ç§°ä¸ºrouteï¼‰æ˜¯Vueæä¾›çš„è·¯ç”±ç»„ä»¶ï¼Œä¸»è¦ç”±3æ–¹é¢æ„æˆï¼š</p><ul><li><p>router-linkï¼šè¯·æ±‚é“¾æ¥ç»„ä»¶ï¼Œæµè§ˆå™¨ä¼šè§£ææˆaæ ‡ç­¾</p></li><li><p>router-viewï¼šåŠ¨æ€è§†å›¾ç»„ä»¶ï¼Œç”¨æ¥æ¸²æŸ“å±•ç¤ºä¸è·¯ç”±è·¯å¾„å¯¹åº”çš„ç»„ä»¶</p></li><li><p>è·¯ç”±è¡¨routerå¦‚ä¸‹å›¾</p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250622181125012.png" alt="image-20250622181125012"></p></li></ul><p>ä¸‹é¢æˆ‘ä»¬ä»ä¸‰ä¸ªè§’åº¦äº†è§£route</p><hr><h3 id="router-link">router-link</h3><p>è¯¥æ ‡ç­¾é€šå¸¸æ·»åŠ åœ¨buttonï¼Œmenuç­‰æ ‡ç­¾å¤–ï¼Œè¡¨ç¤ºç‚¹å‡»è¯¥ç»„ä»¶ï¼Œå¯åŠ¨è·¯ç”±è·³åˆ°ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œä¾‹å¦‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;&quot;</span>&gt;</span> //æ·»åŠ ä¸‹ä¸€è·³çš„åœ°å€</span><br><span class="line">    <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">&quot;/index&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-icon</span>&gt;</span><span class="tag">&lt;<span class="name">Promotion</span> /&gt;</span><span class="tag">&lt;/<span class="name">el-icon</span>&gt;</span> é¦–é¡µ</span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br></pre></td></tr></table></figure><p>elementçš„menuç»„ä»¶ä¸­é›†æˆäº†è¯¥åŠŸèƒ½ä¸Šè¿°ä»£ç ç­‰ä»·äº</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-menu</span> <span class="attr">router</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-menu-item</span> <span class="attr">index</span>=<span class="string">&quot;/index&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-icon</span>&gt;</span><span class="tag">&lt;<span class="name">Promotion</span> /&gt;</span><span class="tag">&lt;/<span class="name">el-icon</span>&gt;</span> é¦–é¡µ</span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-menu-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-menu</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨é¡¶çº§èœå•æ ä¸­æ·»åŠ &quot;router&quot;å³å¯ï¼Œä¼šè‡ªåŠ¨æ ¹æ®indexä¸­çš„å†…å®¹å¯»æ‰¾ä¸‹ä¸€è·³çš„åœ°å€</p><hr><h3 id="router-view">router-view</h3><p><strong>åŠ¨æ€æ¸²æŸ“ç»„ä»¶</strong>ï¼Œå°†ä¸‹ä¸€è·³çš„ç»„ä»¶åœ¨æ ‡ç­¾ä½ç½®æ¸²æŸ“å‡ºæ¥ï¼Œé€šå¸¸åŠ åœ¨å…·æœ‰containeråŠŸèƒ½çš„æ ‡ç­¾å†…ã€‚ä¾‹å¦‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-main</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-main</span>&gt;</span></span><br><span class="line">//ä¸‹ä¸€è·³çš„ç»„ä»¶å°†åŠ è½½åœ¨<span class="tag">&lt;<span class="name">el-main</span>&gt;</span><span class="tag">&lt;/<span class="name">el_main</span>&gt;</span>çš„å†…å®¹é‡Œ</span><br></pre></td></tr></table></figure><hr><h3 id="è·¯ç”±è¡¨router">è·¯ç”±è¡¨router</h3><p>å†³å®šè¯¥è·¯å¾„ä¸‹ï¼Œè®¿é—®çš„ç»„ä»¶æ˜¯ä»€ä¹ˆã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¼å…¥IndexViewç»„ä»¶</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">IndexView</span> <span class="keyword">from</span> <span class="string">&#x27;@/views/index/index.vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line"><span class="comment">//é…ç½®è·¯ç”±ä¿¡æ¯</span></span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&#x27;/index&#x27;</span>, <span class="attr">component</span>: <span class="title class_">IndexView</span> &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">  <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">  routes,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router;</span><br></pre></td></tr></table></figure><hr><p>è¿›é˜¶ç”¨æ³•:</p><ul><li><a href="https://router.vuejs.org/zh/guide/essentials/nested-routes.html">åµŒå¥—è·¯ç”±</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>äºŒçº§åŸŸååŠvercelç»‘å®š</title>
      <link href="/2025/06/19/2025.6.19/"/>
      <url>/2025/06/19/2025.6.19/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€">å‰è¨€</h3><p>è¿™é‡Œé»˜è®¤å¤§å®¶å·²ç»æ‹¥æœ‰è‡ªå·±çš„åŸŸåï¼Œåˆ›å»ºäºŒçº§åŸŸåä¸»è¦ç›®çš„æ˜¯ï¼š<br>åœ¨ä½ ä¸»åŸŸåå·²ç»ç»‘å®šçš„å‰æä¸‹ï¼Œä¸æƒ³é‡æ–°å†ä¹°ä¸€ä¸ªåŸŸåè¿›è¡Œåˆ«çš„ç½‘ç«™çš„ç»‘å®š</p><hr><h3 id="åˆ›å»ºäºŒçº§åŸŸå">åˆ›å»ºäºŒçº§åŸŸå</h3><p>æ‰“å¼€ä½ è´­ä¹°åŸŸåçš„å®˜ç½‘ï¼ˆè¿™é‡Œä»¥<a href="https://www.aliyun.com">é˜¿é‡Œäº‘</a>ä¸ºä¾‹ï¼‰</p><div class="note info simple"><p>æœç´¢åŸŸåæ§åˆ¶å°ï¼Œè¿›å…¥åŸŸåç®¡ç†</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620173247119.png" alt="image-20250620173247119"></p><div class="note info simple"><p>è¿›å…¥<strong>åŸŸååˆ—è¡¨</strong>ï¼Œç‚¹å‡»è§£æ</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620173415215.png" alt="image-20250620173415215"></p><div class="note info simple"><p>ç‚¹å‡»<strong>æ·»åŠ åŸŸå</strong>ï¼Œå¡«å…¥åŸŸåçš„åå­—<strong>å‰ç¼€ä¸èƒ½æ˜¯å¤§å†™</strong></p></div><h6 id="image-20250620173742135"><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620173742135.png" alt="image-20250620173742135"></h6><div class="note info simple"><p>ç‚¹å‡»<strong>TXTæˆæƒæ ¡éªŒ</strong>ï¼Œä¿å­˜TXTè®°å½•</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620173948316.png" alt="image-20250620173948316"></p><div class="note info simple"><p>è¿›å…¥ä¸»åŸŸåçš„<strong>è§£æè®¾ç½®</strong>ï¼Œ<strong>è¿™é‡Œä¸€å®šå¾—æ˜¯ä¸»åŸŸåï¼</strong></p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620174108097.png" alt="image-20250620174108097"></p><div class="note info simple"><p><strong>æ·»åŠ è®°å½•</strong>ï¼Œå°†è®°å½•å¡«å…¥ï¼Œ<strong>è®°å½•ç±»å‹è¦é€‰æ‹©TXT</strong></p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620174343636.png" alt="image-20250620174343636"></p><div class="note info simple"><p>è¿”å›è¿›è¡ŒTXTæ£€æµ‹</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620174610973.png" alt="image-20250620174610973"></p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620174649423.png" alt="image-20250620174649423"></p><h3 id="å°†åŸŸåè§£æè‡³vercel">å°†åŸŸåè§£æè‡³vercel</h3><div class="note info simple"><p>è¿™é‡Œå‡è®¾ä½ å·²ç»åœ¨vercelä¸Šé¢åˆ›å»ºå¥½é¡¹ç›®ï¼Œå‡†å¤‡ç»‘å®šåŸŸå</p></div><ul><li><p>è¿›å…¥é¡¹ç›®ï¼Œç‚¹å‡»<strong>Domains</strong></p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620181547727.png" alt="image-20250620181547727"></p></li><li><p>ç‚¹å‡»<strong>add domains</strong>ï¼Œè¾“å…¥ä½ çš„åŸŸåå¹¶ä¿å­˜</p><div class="note warning simple"><p>ä½ ä¼šçœ‹åˆ°Invalid Configurationçš„è­¦å‘Šï¼Œè¿™æ˜¯å› ä¸ºä½ è¿˜æ²¡æœ‰é…ç½®</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620181638318.png" alt="image-20250620181638318"></p></li><li><p>ç‚¹å‡»è¿›å…¥è§£æé¡µé¢ï¼Œå°†è®°å½•å€¼ä¿å­˜ä¸‹æ¥</p><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620181713838.png" alt="image-20250620181713838"></p></li><li><p>å›åˆ°é˜¿é‡Œäº‘åŸŸååˆ—è¡¨ï¼Œå¯¹ä½ çš„äºŒçº§åŸŸåè§£æè®¾ç½®</p><div class="note warning simple"><p>æ˜¯åˆšåˆšåˆ›å»ºçš„äºŒçº§åŸŸå!</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620181759564.png" alt=""></p></li><li><p>æ·»åŠ ä¸¤æ¡è§£æè®°å½•</p><div class="note warning simple"><p>ç¬¬ä¸€æ¡åŸºæœ¬æ˜¯ä¸€æ ·çš„ï¼Œè®°å½•å€¼ä¸º76.76.21.21</p><p>ç¬¬äºŒæ¡å°±è¦çœ‹ä½ çš„è®°å½•å¡«äº†</p></div><p><img src="https://m1kasaz-typora.oss-cn-beijing.aliyuncs.com/images/image-20250620181823482.png" alt="image-20250620181823482"></p></li><li><p>è¿”å›vercelï¼Œæ­£å¸¸æƒ…å†µä¸‹ä½ çš„åŸŸåå°±ç»‘å®šæˆåŠŸäº†</p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> åŸŸå </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆå¸–</title>
      <link href="/2025/06/18/2025.6.18/"/>
      <url>/2025/06/18/2025.6.18/</url>
      
        <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>å†™ä¸‹è¿™è´´æ—¶åšä¸»å·²ç»è¢«2çº§åŸŸååˆ›å»ºæŠ˜ç£¨å¾—ç—›ä¸æ¬²ç”Ÿå•Šå•Šå•Š<br>å®¶äººä»¬åœ¨é˜¿é‡Œäº‘æ·»åŠ äºŒçº§åŸŸåçš„å‰ç¼€é¦–å­—æ¯ä¸€å®šä¸è¦å¤§å†™ ğŸ˜­ ğŸ˜­ (2025.6.18 23:44)</p><h1>å»ºç«™åˆè¡·</h1><p>åšä¸»ä¸€å­—è”¡ï¼Œå¸Œæœ›åœ¨è¿™é‡Œåˆ†äº«ä¸€äº›è‡ªå·±å­¦åˆ°çš„æŠ€æœ¯ï¼Œé‡åˆ°çš„é—®é¢˜å§ï¼Œç»™è‡ªå·±ä¸€äº›åŠ¨åŠ›ã€‚<br>ä¹Ÿæ¬¢è¿å¤§å®¶åœ¨è¯„è®ºåŒºå‹å¥½äº¤æµï¼Œä¸€èµ·è¿›æ­¥ã€‚</p><p>å»ºç«™æ˜¯å‚è€ƒäº†å¥½å‡ ä¸ªå“¥çš„æ–‡ç« : <a href="https://github.com/m1kasaz/m1kasaz.github.io?tab=readme-ov-file">README</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
